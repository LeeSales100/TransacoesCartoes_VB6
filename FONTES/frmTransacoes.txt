Private Sub Text1_Change()

End Sub

Private Sub Text3_Change()

End Sub

Private Sub Command1_Click()

End Sub

Private Sub cmdInclusao_Click()
Dim sql As String
Dim sDataSQL As String
MsgBox "Valor digitado: " & mskData.Text

If Not IsDate(mskData.Text) Then
   MsgBox "ERRO: Não é uma data!"
   Exit Sub
End If

sDataSQL = Format$(CDate(mskData.Text), "yyyy-mm-dd hh:nn:ss")

Call AbrirConexao

sql = "INSERT INTO Transacoes " & _
      "(nr_cartao, Vl_Transacao, Dt_Transacao, Descricao, St_Transacao) " & _
      "VALUES (" & _
      "'" & txtNumeroCartao.Text & "', " & _
      Replace(txtValor.Text, ",", ".") & ", " & _
      "CONVERT(datetime, '" & sDataSQL & "', 120), " & _
      "'" & txtDescricao.Text & "', " & _
      "'" & cboStatus.Text & "'" & _
      ")"
                cn.Execute (sql)
                MsgBox UCase("Dados Cadastrados com Sucesso")
                
      Call FecharConexao
                
                
End Sub
Private Sub cmdAlterar_Click()
    Dim sql As String
    Dim sDataSQL As String
    
    Call AbrirConexao

    ' Sanitiza máscara
    mskData.Text = Replace(mskData.Text, "_", "")
    
    MsgBox "Data convertida: " & Format$(CDate(mskData.Text), "yyyy-mm-dd hh:nn:ss")
    ' Validação adicional
    If Trim(mskData.Text) = "" Then
        MsgBox "Data não pode estar vazia.", vbExclamation
        Exit Sub
    End If
    
    If Not IsDate(mskData.Text) Then
        MsgBox "Data inválida! Use o formato dd/mm/yyyy hh:nn:ss", vbExclamation
        Exit Sub
    End If

    ' Tentativa de conversão segura
    On Error GoTo TrataErroData
    
    sDataSQL = Format$(CDate(mskData.Text), "yyyy-mm-dd") & "T" & Format$(CDate(sDataLimpa), "HH:mm:ss")
    
    On Error GoTo 0 ' limpa o tratamento de erro

    ' Verifica visualmente o valor antes de enviar ao SQL
    Debug.Print "Data convertida para SQL: " & sDataSQL

    ' Monta o UPDATE
    sql = "UPDATE Transacoes SET " & _
          "nr_cartao = '" & txtNumeroCartao.Text & "', " & _
          "Vl_Transacao = " & Replace(txtValor.Text, ",", ".") & ", " & _
          "Dt_Transacao = '" & sDataSQL & "', " & _
          "Descricao = '" & txtDescricao.Text & "', " & _
          "St_Transacao = '" & cboStatus.Text & "' " & _
          "WHERE Id_Trans = " & lblId_Trans.Caption

    cn.Execute sql

    MsgBox "Transação alterada com sucesso!", vbInformation
    Call LimpaCampos
    Call FecharConexao
    
    ' Volta para modo inclusão
    cmdIncluir.Enabled = True
    cmdAlterar.Enabled = False
    cmdExcluir.Enabled = False
    lblId_Trans.Caption = ""

    Exit Sub

TrataErroData:
    MsgBox "Falha ao converter a data. Verifique o valor digitado e o formato!", vbCritical
    Exit Sub
End Sub

Private Sub cmdExcluir_Click()
   Dim resposta As Integer
   Dim sql As String
   
   Call AbrirConexao
   
   ' Confirma exclusão com o usuário
   resposta = MsgBox("Tem certeza que deseja excluir esta transação?", vbYesNo + vbQuestion, "Confirmação")
   
   If resposta = vbNo Then Exit Sub
   
   ' Verifica se temos o ID válido
   If Trim(lblId_Trans.Caption) = "" Then
       MsgBox "Nenhuma transação selecionada!", vbExclamation
       Exit Sub
   End If
   
   ' Executa o DELETE com base na chave primária
   sql = "DELETE FROM Transacoes WHERE Id_Trans = " & lblId_Trans.Caption
   cn.Execute sql
   
   MsgBox "Transação excluída com sucesso!", vbInformation
   
   ' Limpa o formulário e volta ao modo inclusão
   txtNumeroCartao.Text = ""
   txtValor.Text = ""
   txtDescricao.Text = ""
   cboStatus.ListIndex = 0
   mskData.Text = "__/__/____ __:__"
   lblId_Trans.Caption = ""
   
   cmdIncluir.Enabled = True
   cmdAlterar.Enabled = False
   cmdExcluir.Enabled = False
   
   Call FecharConexao
   Call LimpaCampos
End Sub

Private Sub cmdIncluir_Click()
    Dim sql As String
    Dim sDataSQL As String
    
    Call AbrirConexao
    ' Verifica se campos obrigatórios estão preenchidos
    If Trim(txtNumeroCartao.Text) = "" Then
        MsgBox "Informe o número do cartão.", vbExclamation
        Exit Sub
    End If
    
    If Trim(txtValor.Text) = "" Then
        MsgBox "Informe o valor da transação.", vbExclamation
        Exit Sub
    End If

    If Not IsDate(mskData.Text) Then
        MsgBox "Data inválida. Verifique o campo Data.", vbExclamation
        Exit Sub
    End If

    If cboStatus.ListIndex = -1 Then
        MsgBox "Selecione o status da transação.", vbExclamation
        Exit Sub
    End If

    ' Converte a data para formato SQL Server
    sDataSQL = Format$(CDate(mskData.Text), "yyyy-mm-dd hh:mm")
  '  sDataSQL = Format$(CDate(mskData.Text), "yyyy-mm-dd") & "T" & Format$(CDate(sDataLimpa), "HH:mm:ss")
  
   '  sDataSQL = Format$(CDate(mskData.Text), "yyyy-MM-dd HH:mm")
sDataSQL = Format$(CDate(mskData.Text), "yyyy-MM-dd HH:mm")


    
    ' Monta SQL de inserção
    sql = "SET LANGUAGE ENGLISH;" & _
    "INSERT INTO Transacoes " & _
          "(nr_cartao, Vl_Transacao, Dt_Transacao, Descricao, St_Transacao) " & _
          "VALUES (" & _
          "'" & txtNumeroCartao.Text & "', " & _
          Replace(txtValor.Text, ",", ".") & ", " & _
          "'" & sDataSQL & "', " & _
          "'" & txtDescricao.Text & "', " & _
          "'" & cboStatus.Text & "'" & _
          ")"

    ' Executa o comando
    cn.Execute sql

    MsgBox "Transação cadastrada com sucesso!", vbInformation

Dim sConcat As String

sConcat = "Inclusão de Transação as " & Now & " - " & _
          txtNumeroCartao.Text & " - " & _
          txtValor.Text & " - " & _
          txtDescricao.Text & " - " & _
          mskData.Text & " - " & _
          txtDescricao.Text & " - " & _
          cboStatus.Text

          GravaLog (sConcat)


    
    Call LimpaCampos
    ' Limpa campos
    'txtNumeroCartao.Text = ""
    'txtValor.Text = ""
    'mskData.Text = Format$(Now, "dd/mm/yyyy hh:nn:ss")
    'txtDescricao.Text = ""
    'cboStatus.ListIndex = -1

    ' Volta para modo inclusão
    cmdIncluir.Enabled = True
    cmdAlterar.Enabled = False
    cmdExcluir.Enabled = False
    Call FecharConexao
    
    
End Sub

Public Sub GravaLog(ByVal sTexto As String)
   Dim sql As String
   sql = "INSERT INTO Log (Mensagem) Values (" & "'" & sTexto & "')"
   cn.Execute RTrim(sql)
End Sub
Private Sub Form_Load()
   mskData.Text = Format$(Now, "dd/mm/yyyy HH:mm")
   txtNumeroCartao.MaxLength = 16
   txtValor = 15
   txtDescricao.MaxLength = 255
                  
     With cboStatus
         .Clear
         .AddItem "APROVADA"
         .AddItem "PENDENTE"
         .AddItem "CANCELADA"
         .ListIndex = 0 ' Deixa "Aprovada" selecionada por padrão
     End With
     
     ' Modo padrão: Inclusão
     cmdIncluir.Enabled = True
     cmdAlterar.Enabled = False
     cmdExcluir.Enabled = False
End Sub
Private Sub Label1_Click()
N
End Sub

Private Sub txtNumeroCartao_LostFocus()
    Dim rs As New ADODB.Recordset
    Dim sql As String
    
    Call AbrirConexao


    If Trim(txtNumeroCartao.Text) = "" Then Exit Sub ' evita busca vazia

    sql = "SELECT * FROM Transacoes WHERE nr_cartao = '" & txtNumeroCartao.Text & "'"
    rs.Open sql, cn, adOpenStatic, adLockReadOnly

    If Not rs.EOF Then
        ' Transação EXISTE ? Modo Alteração/Exclusão

        ' Preenche os campos do formulário
        txtValor.Text = rs!Vl_Transacao
        mskData.Text = Format$(rs!Dt_Transacao, "dd/mm/yyyy hh:nn")
        txtDescricao.Text = rs!Descricao
        cboStatus.Text = rs!St_Transacao

        ' Guarda o ID para uso posterior
        lblId_Trans.Caption = rs!Id_Trans  ' ou use uma variável como idTransAtual

        ' Habilita os botões corretos
        cmdIncluir.Enabled = False
        cmdAlterar.Enabled = True
        cmdExcluir.Enabled = True

        ' Se status for 'Aprovada', bloqueia alteração/exclusão
        If cboStatus.Text = "Aprovada" Then
            cmdAlterar.Enabled = False
            cmdExcluir.Enabled = False
            MsgBox "Transação aprovada não pode ser alterada ou excluída!", vbInformation
        End If
    Else
        ' Transação NÃO EXISTE ? Modo Inclusão

        ' Limpa os campos para nova inserção
        txtValor.Text = ""
        txtDescricao.Text = ""
        cboStatus.ListIndex = 0
        mskData.Text = Format$(Now, "dd/mm/yyyy hh:nn")

        ' Botões configurados para modo inclusão
        cmdIncluir.Enabled = True
        cmdAlterar.Enabled = False
        cmdExcluir.Enabled = False

        lblId_Trans.Caption = "" ' zera o ID guardado
    End If

    rs.Close
    Set rs = Nothing
    Call FecharConexao

End Sub

Private Sub LimpaCampos()
   txtNumeroCartao = ""
   txtValor = ""
   txtDescricao = ""
   mskData.Text = Format$(Now, "dd/mm/yyyy HH:mm")
   cboStatus.ListIndex = 0
        
End Sub

Private Sub txtValor_KeyPress(KeyAscii As Integer)
    Select Case KeyAscii
        Case 8    ' Backspace (permite apagar)
        Case 48 To 57    ' Números de 0 a 9
        Case 44 ', 46      ' Vírgula (,) ou Ponto (.) — depende do regional settings
        Case Else
            KeyAscii = 0 ' Bloqueia qualquer outro caractere
    End Select
End Sub


